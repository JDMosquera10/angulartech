<!-- Dashboard Header -->
<div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding: 1rem; background: var(--color-surface); border-radius: 8px;">
    <div>
        <h2 style="margin: 0; color: var(--text-primary);">Dashboard de Máquinas</h2>
        <p style="margin: 0.5rem 0 0 0; color: var(--text-secondary); font-size: 0.875rem;">
            @if (lastUpdate) {
                Última actualización: {{ lastUpdate | date:'short':'es-ES' }}
            } @else {
                Cargando datos...
            }
            @if (isLoading) {
                <mat-icon style="font-size: 1rem; margin-left: 0.5rem; animation: spin 1s linear infinite;">refresh</mat-icon>
            }
        </p>
    </div>
    <div style="display: flex; gap: 0.5rem;">
        <button mat-raised-button color="primary" (click)="refreshDashboard()" [disabled]="isLoading">
            <mat-icon style="margin-right: 0.5rem;">refresh</mat-icon>
            Actualizar
        </button>
        <button mat-icon-button [matTooltip]="'Estado de conexión: ' + (webSocketService.isConnected() ? 'Conectado' : 'Desconectado')">
            <mat-icon [style.color]="webSocketService.isConnected() ? '#4caf50' : '#f44336'">
                {{ webSocketService.isConnected() ? 'wifi' : 'wifi_off' }}
            </mat-icon>
        </button>
    </div>
</div>

<div class="grid-stack" #gridRef ngSkipHydration>
   <!-- Alertas -->
   <div class="grid-stack-item" gs-x="10" gs-y="0" gs-w="12" gs-h="2">
    <div class="grid-stack-item-content card alerts-container">
        <h3><mat-icon style="font-size: 1.2rem; vertical-align: middle;">notifications_active</mat-icon> Alertas de Mantenimiento</h3>
        <ul class="alerts-list">
            @if (isLoading) {
                <li class="loading-alert">
                    <mat-icon style="font-size: 1rem; vertical-align: middle; margin-right: 0.5rem; animation: spin 1s linear infinite;">refresh</mat-icon>
                    Cargando alertas...
                </li>
            } @else if (dashboardData && dashboardData.alerts && dashboardData.alerts.length > 0) {
                @for (alert of getSortedAlerts(); track alert.id) {
                    <li [class]="getAlertClass(alert)">
                        <mat-icon style="font-size: 1rem; vertical-align: middle; margin-right: 0.5rem;" [style.color]="getAlertIconColor(alert)">
                            {{ getAlertIcon(alert) }}
                        </mat-icon>
                        {{ alert.machineModel }} - {{ getAlertText(alert) }}
                        <span [class]="getAlertSpanClass(alert)">
                            {{ getAlertDaysText(alert) }}
                        </span>
                    </li>
                }
            } @else {
                <li class="no-alerts">
                    <mat-icon style="font-size: 1rem; vertical-align: middle; margin-right: 0.5rem; color: #4caf50;">check_circle</mat-icon>
                    No hay alertas de mantenimiento pendientes
                </li>
            }
        </ul>
    </div>
</div>

    <!-- Gráfico Mantenimientos por Mes -->
    <div class="grid-stack-item" gs-x="0" gs-y="0" gs-w="4" gs-h="3">
        <div class="grid-stack-item-content card">
            <h3><mat-icon style="font-size: 1.2rem; vertical-align: middle;">analytics</mat-icon> Mantenimientos por Mes</h3>
            <div class="chart-container">
                <canvas baseChart 
                        #barChart
                        [data]="barChartData" 
                        [options]="barChartOptions" 
                        [type]="'bar'">
                </canvas>
            </div>
        </div>
    </div>

    <!-- Gráfico Máquinas Activas vs Inactivas -->
    <div class="grid-stack-item" gs-x="0" gs-y="2" gs-w="4" gs-h="3">
        <div class="grid-stack-item-content card">
            <h3><mat-icon style="font-size: 1.2rem; vertical-align: middle;">donut_large</mat-icon> Estado de Máquinas</h3>
            <div class="chart-container">
                <canvas baseChart 
                        #doughnutChart
                        [data]="doughnutChartData" 
                        [options]="doughnutChartOptions" 
                        [type]="'doughnut'">
                </canvas>
            </div>
        </div>
    </div>

    <!-- Tabla Inventario de Máquinas -->
    <div class="grid-stack-item" gs-x="4" gs-y="0" gs-w="5" gs-h="6">
        <div class="grid-stack-item-content card table-card">
            <h3>Inventario de Máquinas</h3>
            <div style="width: 98%;" class="mat-elevation-z8">
                <table mat-table [dataSource]="dataSource" class="mat-elevation-z8">
                    <!-- Position Column -->
                    <ng-container matColumnDef="model">
                        <th mat-header-cell *matHeaderCellDef> Modelo. </th>
                        <td mat-cell *matCellDef="let element"> {{element.model}} </td>
                    </ng-container>

                    <!-- Name Column -->
                    <ng-container matColumnDef="serialNumber">
                        <th mat-header-cell *matHeaderCellDef> Serie </th>
                        <td mat-cell *matCellDef="let element"> {{element.serialNumber}} </td>
                    </ng-container>

                    <!-- Weight Column -->
                    <ng-container matColumnDef="client">
                        <th mat-header-cell *matHeaderCellDef> Cliente </th>
                        <td mat-cell *matCellDef="let element"> {{element.client}} </td>
                    </ng-container>

                    <!-- Symbol Column -->
                    <ng-container matColumnDef="expirationDate">
                        <th mat-header-cell *matHeaderCellDef>Próx. Mantenimiento</th>
                        <td mat-cell *matCellDef="let element"> {{element.expirationDate}} </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                </table>
                <mat-paginator style="width: 100%;" [pageSizeOptions]="[7]" showFirstLastButtons
                    aria-label="Select page of periodic elements">
                </mat-paginator>
            </div>
        </div>
    </div>

    <!-- KPIs -->
    <div class="grid-stack-item" gs-x="10" gs-y="0" gs-w="3" gs-h="1">
        <div class="grid-stack-item-content card kpi">
            <mat-icon style="position: absolute; top: 1rem; right: 1rem; opacity: 0.3; font-size: 2rem;">precision_manufacturing</mat-icon>
            <h1>{{ dashboardData?.stats?.totalMachines || 24 }}</h1>
            <p>Total Máquinas</p>
        </div>
    </div>

    <div class="grid-stack-item" gs-x="10" gs-y="1" gs-w="3" gs-h="1">
        <div class="grid-stack-item-content card kpi">
            <mat-icon style="position: absolute; top: 1rem; right: 1rem; opacity: 0.3; font-size: 2rem; color: #f0961b;">build_circle</mat-icon>
            <h1>{{ dashboardData?.stats?.pendingMaintenances || 8 }}</h1>
            <p>Mantenimientos Pendientes</p>
        </div>
    </div>

    <div class="grid-stack-item" gs-x="10" gs-y="2" gs-w="3" gs-h="1">
        <div class="grid-stack-item-content card kpi">
            <mat-icon style="position: absolute; top: 1rem; right: 1rem; opacity: 0.3; font-size: 2rem; color: #a44a5d;">warning</mat-icon>
            <h1>{{ dashboardData?.stats?.upcomingAlerts || 3 }}</h1>
            <p>Alertas Próximas</p>
        </div>
    </div>

    <!-- Gráfico Máquinas Activas vs Inactivas -->
    <div class="grid-stack-item" gs-x="10" gs-y="3" gs-w="3" gs-h="3">
        <div class="grid-stack-item-content card">
            <h3><mat-icon style="font-size: 1.2rem; vertical-align: middle;">inventory_2</mat-icon> Consumo de Repuestos</h3>
            <div class="chart-container">
                <canvas baseChart 
                        #lineChart
                        [data]="lineChartData" 
                        [options]="lineChartOptions" 
                        [type]="'line'">
                </canvas>
            </div>
        </div>
    </div>

 
</div>